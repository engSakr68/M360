# frozen_string_literal: true

 $ios_target_version = '15.0'
platform :ios, $ios_target_version
ENV['COCOAPODS_DISABLE_STATS'] = 'true'

# Use the CocoaPods CDN
source 'https://cdn.cocoapods.org/'

# --- Flutter wiring ---
def flutter_root
  generated = File.expand_path(File.join('..', 'Flutter', 'Generated.xcconfig'), __FILE__)
  raise "#{generated} must exist. Run `flutter pub get` first." unless File.exist?(generated)
  File.foreach(generated) { |l| return $1.strip if l =~ /FLUTTER_ROOT=(.*)/ }
  raise 'FLUTTER_ROOT not found'
end

require File.expand_path(File.join('packages', 'flutter_tools', 'bin', 'podhelper'), flutter_root)
flutter_ios_podfile_setup

# Map the Runner configurations CocoaPods should emit xcconfigs for
project 'Runner', {
  'Debug'   => :debug,
  'Release' => :release,
  'Profile' => :release,
}

# We need module maps for many C/ObjC deps; keep modular headers on
use_modular_headers!

target 'Runner' do
  # Enable frameworks with static linkage
  use_frameworks! :linkage => :static

  flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))

  # --- Local Openpath pods
  pod 'OpenpathMobile',         :path => File.expand_path('vendor/openpath/OpenpathMobile', __dir__)
  pod 'OpenpathMobileAllegion', :path => File.expand_path('vendor/openpath/OpenpathMobileAllegion', __dir__)
  pod 'OpenSSL-Universal',      '1.1.2301'

  # --- Local Amplitude (Swift + Core) combined binary pod
  pod 'AmplitudeBinary', :path => File.expand_path('vendor/openpath', __dir__)

  # --- PromiseKit: Using the main pod with frameworks enabled
  pod 'PromiseKit', '~> 8.0'
  
  # --- Skip SwiftCBOR from CocoaPods and handle it manually
  # We'll embed it in a script phase instead
  
  # --- Other dependencies
  pod 'DKImagePickerController', '4.3.3'
  pod 'DKPhotoGallery', '0.0.17'
  
  # --- Firebase pods with updated versions to match plugin requirements
  pod 'Firebase/Core', '12.2.0'
  pod 'Firebase/Analytics', '12.2.0'
  pod 'Firebase/Crashlytics', '12.2.0'
  pod 'Firebase/Messaging', '12.2.0'
end

post_install do |installer|
  # --- Flutter defaults + some safe globals
  installer.pods_project.targets.each do |t|
    flutter_additional_ios_build_settings(t)
    t.build_configurations.each do |cfg|
      cfg.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = $ios_target_version
      cfg.build_settings['ALWAYS_EMBED_SWIFT_STANDARD_LIBRARIES'] = 'YES'
      # If building on Intel macOS, keep the next line; on Apple Silicon you can remove it.
      cfg.build_settings['EXCLUDED_ARCHS[sdk=iphonesimulator*]'] = 'arm64'
    end
  end

  # --- Disable BUILD_LIBRARY_FOR_DISTRIBUTION for ALL targets
  puts "ðŸ”§ Disabling BUILD_LIBRARY_FOR_DISTRIBUTION for all targets..."
  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      config.build_settings['BUILD_LIBRARY_FOR_DISTRIBUTION'] = 'NO'
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = $ios_target_version
      config.build_settings['SWIFT_COMPILATION_MODE'] = 'wholemodule'
    end
  end
  puts "âœ… BUILD_LIBRARY_FOR_DISTRIBUTION disabled for all targets"

  # --- Add privacy bundle script phases for all plugins
  installer.pods_project.targets.each do |target|
    # Remove any existing privacy script phases first
    target.shell_script_build_phases.dup.each do |phase|
      if phase.name.to_s.downcase.include?('privacy') || phase.name.to_s.include?('ðŸ©¹')
        target.build_phases.delete(phase)
        puts "â€¢ Removed script phase: #{target.name} - #{phase.name}"
      end
    end
    
    # List of plugins that need privacy bundles
    privacy_plugins = [
      'url_launcher_ios',
      'sqflite_darwin',
      'permission_handler_apple',
      'shared_preferences_foundation',
      'share_plus',
      'path_provider_foundation',
      'package_info_plus'
    ]
    
    # Add privacy bundle script phase for each plugin
    if privacy_plugins.include?(target.name)
      privacy_phase = target.new_shell_script_build_phase('[CP] Copy Privacy Bundle')
      privacy_phase.shell_path = '/bin/sh'
      privacy_phase.show_env_vars_in_log = false
      privacy_phase.shell_script = <<~SCRIPT
        set -e
        set -u
        set -o pipefail
        
        echo "=== Copying #{target.name} Privacy Bundle ==="
        
        SRCROOT="${SRCROOT}"
        BUILT_PRODUCTS_DIR="${BUILT_PRODUCTS_DIR}"
        FRAMEWORKS_FOLDER_PATH="${FRAMEWORKS_FOLDER_PATH}"
        
        PRIVACY_BUNDLE_SRC="${SRCROOT}/#{target.name}_privacy.bundle"
        PRIVACY_BUNDLE_DST="${BUILT_PRODUCTS_DIR}/${FRAMEWORKS_FOLDER_PATH}/#{target.name}_privacy.bundle"
        
        # Also try the target-specific directory
        TARGET_DST="${BUILT_PRODUCTS_DIR}/#{target.name}/#{target.name}_privacy.bundle"
        
        if [ -d "${PRIVACY_BUNDLE_SRC}" ]; then
          echo "Copying privacy bundle from ${PRIVACY_BUNDLE_SRC}"
          
          # Copy to frameworks folder
          mkdir -p "${BUILT_PRODUCTS_DIR}/${FRAMEWORKS_FOLDER_PATH}"
          cp -R "${PRIVACY_BUNDLE_SRC}" "${PRIVACY_BUNDLE_DST}"
          echo "âœ… Copied to frameworks folder: ${PRIVACY_BUNDLE_DST}"
          
          # Copy to target-specific directory
          mkdir -p "${BUILT_PRODUCTS_DIR}/#{target.name}"
          cp -R "${PRIVACY_BUNDLE_SRC}" "${TARGET_DST}"
          echo "âœ… Copied to target directory: ${TARGET_DST}"
          
          echo "âœ… #{target.name} privacy bundle copied successfully"
        else
          echo "âš ï¸ Privacy bundle not found at ${PRIVACY_BUNDLE_SRC}"
          # Create minimal privacy bundle as fallback
          mkdir -p "${TARGET_DST}"
          cat > "${TARGET_DST}/#{target.name}_privacy" << 'PRIVACY_EOF'
{
  "NSPrivacyTracking": false,
  "NSPrivacyCollectedDataTypes": [],
  "NSPrivacyAccessedAPITypes": []
}
PRIVACY_EOF
          echo "âœ… Created minimal privacy bundle for #{target.name}"
        fi
      SCRIPT
      puts "âœ… Added privacy bundle script phase for #{target.name}"
    end
  end

  # --- Get the app target
  app_target = installer.pods_project.targets.find { |t| t.name == 'Runner' }
  
  if app_target
    # Remove any existing SwiftCBOR script phases
    app_target.shell_script_build_phases.dup.each do |phase|
      if phase.name.to_s.downcase.include?('swiftcbor') || phase.name.to_s.include?('ðŸ©¹')
        app_target.build_phases.delete(phase)
        puts "â€¢ Removed script phase from Runner: #{phase.name}"
      end
    end

    # Create a script phase to embed SwiftCBOR framework
    embed_framework_phase = app_target.new_shell_script_build_phase('[CP] Embed SwiftCBOR Framework')
    embed_framework_phase.shell_path = '/bin/sh'
    embed_framework_phase.show_env_vars_in_log = false
    embed_framework_phase.dependency_file = nil
    
    # Script to embed the SwiftCBOR framework
    embed_script = <<~SCRIPT
      set -e
      set -u
      set -o pipefail
      
      echo "=== Embedding SwiftCBOR Framework ==="
      
      # Paths
      FRAMEWORK_NAME="SwiftCBOR.framework"
      BUILT_PRODUCTS_DIR="${BUILT_PRODUCTS_DIR}"
      CONTAINER_FRAMEWORKS_DIR="${BUILT_PRODUCTS_DIR}/${FRAMEWORKS_FOLDER_PATH}"
      LOCAL_FRAMEWORK_PATH="${SRCROOT}/${FRAMEWORK_NAME}"
      
      # Create the frameworks directory if it doesn't exist
      mkdir -p "${CONTAINER_FRAMEWORKS_DIR}"
      
      # Check if the local framework exists
      if [ -d "${LOCAL_FRAMEWORK_PATH}" ]; then
        echo "Found local SwiftCBOR framework at: ${LOCAL_FRAMEWORK_PATH}"
        
        # Copy the framework to the app bundle
        echo "Copying framework to app bundle..."
        cp -R "${LOCAL_FRAMEWORK_PATH}" "${CONTAINER_FRAMEWORKS_DIR}/"
        
        # Verify the framework was copied
        if [ -d "${CONTAINER_FRAMEWORKS_DIR}/${FRAMEWORK_NAME}" ]; then
          echo "âœ… SwiftCBOR framework copied successfully"
        else
          echo "âŒ Failed to copy SwiftCBOR framework to app bundle"
          exit 1
        fi
        
        # Code sign the framework
        if [ -n "${EXPANDED_CODE_SIGN_IDENTITY}" ]; then
          echo "Code signing framework..."
          /usr/bin/codesign --force --deep --sign "${EXPANDED_CODE_SIGN_IDENTITY}" --timestamp=none "${CONTAINER_FRAMEWORKS_DIR}/${FRAMEWORK_NAME}"
        fi
        
        echo "âœ… SwiftCBOR framework embedded successfully"
      else
        echo "ERROR: Local SwiftCBOR framework not found at ${LOCAL_FRAMEWORK_PATH}"
        exit 1
      fi
      
      # Fix rpath for AllegionAccessBLECredential
      ALLEGION_FRAMEWORK="${CONTAINER_FRAMEWORKS_DIR}/AllegionAccessBLECredential.framework/AllegionAccessBLECredential"
      if [ -f "${ALLEGION_FRAMEWORK}" ]; then
        echo "Fixing rpath for AllegionAccessBLECredential..."
        /usr/bin/install_name_tool -add_rpath "@executable_path/Frameworks" "${ALLEGION_FRAMEWORK}" || echo "Failed to add rpath"
        
        # Check if the binary references SwiftCBOR
        if /usr/bin/otool -L "${ALLEGION_FRAMEWORK}" | grep -q "SwiftCBOR.framework/SwiftCBOR"; then
          echo "Updating SwiftCBOR reference to use @rpath"
          /usr/bin/install_name_tool -change "/usr/local/lib/SwiftCBOR.framework/SwiftCBOR" "@rpath/SwiftCBOR.framework/SwiftCBOR" "${ALLEGION_FRAMEWORK}" || echo "Failed to update reference"
          /usr/bin/install_name_tool -change "@loader_path/../Frameworks/SwiftCBOR.framework/SwiftCBOR" "@rpath/SwiftCBOR.framework/SwiftCBOR" "${ALLEGION_FRAMEWORK}" || echo "Failed to update reference"
        fi
      fi
      
      # Also fix rpath for other Allegion frameworks that might reference SwiftCBOR
      for framework in "AllegionAccessHub" "AllegionBLECore"; do
        FRAMEWORK_PATH="${CONTAINER_FRAMEWORKS_DIR}/${framework}.framework/${framework}"
        if [ -f "${FRAMEWORK_PATH}" ]; then
          echo "Fixing rpath for ${framework}..."
          /usr/bin/install_name_tool -add_rpath "@executable_path/Frameworks" "${FRAMEWORK_PATH}" || echo "Failed to add rpath for ${framework}"
          
          # Check if the binary references SwiftCBOR
          if /usr/bin/otool -L "${FRAMEWORK_PATH}" | grep -q "SwiftCBOR.framework/SwiftCBOR"; then
            echo "Updating SwiftCBOR reference to use @rpath for ${framework}"
            /usr/bin/install_name_tool -change "/usr/local/lib/SwiftCBOR.framework/SwiftCBOR" "@rpath/SwiftCBOR.framework/SwiftCBOR" "${FRAMEWORK_PATH}" || echo "Failed to update reference for ${framework}"
            /usr/bin/install_name_tool -change "@loader_path/../Frameworks/SwiftCBOR.framework/SwiftCBOR" "@rpath/SwiftCBOR.framework/SwiftCBOR" "${FRAMEWORK_PATH}" || echo "Failed to update reference for ${framework}"
          fi
        fi
      done
      
      # Verify the framework is properly embedded
      if [ -d "${CONTAINER_FRAMEWORKS_DIR}/${FRAMEWORK_NAME}" ]; then
        echo "âœ… SwiftCBOR framework verification successful"
      else
        echo "âŒ SwiftCBOR framework verification failed"
        exit 1
      fi
      
      echo "=== SwiftCBOR Framework Embedding Complete ==="
    SCRIPT
    
    embed_framework_phase.shell_script = embed_script
    
    # Move the script phase to be the last phase
    app_target.build_phases.move(embed_framework_phase, app_target.build_phases.count - 1)
    puts "âœ… Added SwiftCBOR framework embedding script phase to Runner target"
    
    # Add privacy bundle copying script phase to Runner target
    privacy_copy_phase = app_target.new_shell_script_build_phase('[CP] Copy Privacy Bundles to App')
    privacy_copy_phase.shell_path = '/bin/sh'
    privacy_copy_phase.show_env_vars_in_log = false
    privacy_copy_phase.shell_script = <<~SCRIPT
      set -e
      set -u
      set -o pipefail
      
      echo "=== Copying Privacy Bundles to App Bundle ==="
      
      SRCROOT="${SRCROOT}"
      BUILT_PRODUCTS_DIR="${BUILT_PRODUCTS_DIR}"
      FRAMEWORKS_FOLDER_PATH="${FRAMEWORKS_FOLDER_PATH}"
      
      # List of plugins that need privacy bundles
      PRIVACY_PLUGINS=(
        "url_launcher_ios"
        "sqflite_darwin"
        "permission_handler_apple"
        "shared_preferences_foundation"
        "share_plus"
        "path_provider_foundation"
        "package_info_plus"
      )
      
      # Copy privacy bundles for all plugins
      for plugin in "${PRIVACY_PLUGINS[@]}"; do
        echo "Processing privacy bundle for: $plugin"
        
        PRIVACY_BUNDLE_SRC="${SRCROOT}/${plugin}_privacy.bundle"
        PRIVACY_BUNDLE_DST="${BUILT_PRODUCTS_DIR}/${FRAMEWORKS_FOLDER_PATH}/${plugin}_privacy.bundle"
        TARGET_DST="${BUILT_PRODUCTS_DIR}/${plugin}/${plugin}_privacy.bundle"
        
        if [ -d "${PRIVACY_BUNDLE_SRC}" ]; then
          echo "Copying ${plugin} privacy bundle..."
          
          # Copy to frameworks folder
          mkdir -p "${BUILT_PRODUCTS_DIR}/${FRAMEWORKS_FOLDER_PATH}"
          cp -R "${PRIVACY_BUNDLE_SRC}" "${PRIVACY_BUNDLE_DST}"
          echo "âœ… Copied to frameworks folder: ${PRIVACY_BUNDLE_DST}"
          
          # Copy to target-specific directory
          mkdir -p "${BUILT_PRODUCTS_DIR}/${plugin}"
          cp -R "${PRIVACY_BUNDLE_SRC}" "${TARGET_DST}"
          echo "âœ… Copied to target directory: ${TARGET_DST}"
          
          echo "âœ… ${plugin} privacy bundle copied"
        else
          echo "âš ï¸ ${plugin} privacy bundle not found at ${PRIVACY_BUNDLE_SRC}"
          # Create minimal privacy bundle as fallback
          mkdir -p "${TARGET_DST}"
          cat > "${TARGET_DST}/${plugin}_privacy" << 'PRIVACY_EOF'
{
  "NSPrivacyTracking": false,
  "NSPrivacyCollectedDataTypes": [],
  "NSPrivacyAccessedAPITypes": []
}
PRIVACY_EOF
          echo "âœ… Created minimal privacy bundle for ${plugin}"
        fi
      done
      
      echo "=== Privacy Bundle Copy Complete ==="
    SCRIPT
    
    # Move the privacy copy phase to be the last phase
    app_target.build_phases.move(privacy_copy_phase, app_target.build_phases.count - 1)
    puts "âœ… Added privacy bundle copying script phase to Runner target"
  else
    puts "âš ï¸ Runner target not found in Pods project"
  end

  # --- Ensure Flutter module/headers are visible
  installer.pods_project.targets.each do |t|
    t.build_configurations.each do |cfg|
      # Framework search paths
      cfg.build_settings['FRAMEWORK_SEARCH_PATHS'] ||= ['$(inherited)']
      fsp = Array(cfg.build_settings['FRAMEWORK_SEARCH_PATHS'])
      fsp += [
        '$(PODS_CONFIGURATION_BUILD_DIR)/Flutter',
        File.join('${SRCROOT}', 'Flutter'),
        File.join('${SRCROOT}')
      ]
      cfg.build_settings['FRAMEWORK_SEARCH_PATHS'] = fsp.uniq

      # Header search paths
      cfg.build_settings['HEADER_SEARCH_PATHS'] ||= ['$(inherited)']
      hsp = Array(cfg.build_settings['HEADER_SEARCH_PATHS'])
      hsp += [
        '$(PODS_ROOT)/Headers/Public',
        '$(PODS_ROOT)/Headers/Public/Flutter',
        '$(PODS_CONFIGURATION_BUILD_DIR)/Flutter/Flutter.framework/Headers',
        File.join('${SRCROOT}', 'Flutter', 'Flutter.framework', 'Headers')
      ]
      cfg.build_settings['HEADER_SEARCH_PATHS'] = hsp.uniq

      cfg.build_settings['CLANG_ENABLE_MODULES'] = 'YES'
    end
  end
end